AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Complete Serverless backend - DynamoDB tables + Lambda functions + API Gateway

Globals:
  Function:
    Runtime: python3.9
    Timeout: 30
    MemorySize: 128
    CodeUri: ./lambda_functions/

Parameters:
  Environment:
    Type: String
    Default: dev  # ðŸ‘ˆ Default dev à¤•à¤° à¤¦à¤¿à¤¯à¤¾
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Deployment environment

  UserPoolId:
    Type: String
    Default: "ap-south-1_njYFt7IuH"
    Description: Cognito User Pool ID

  CognitoClientId:
    Type: String
    Default: "7lq01e0ltn75p29mtejaj96je8"
    Description: Cognito App Client ID

Resources:
  # ==================== DYNAMODB TABLES ====================
  ApartmentsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "ApartmentsTable-${Environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: apartment_id
          AttributeType: S
      KeySchema:
        - AttributeName: apartment_id
          KeyType: HASH

  BuildingsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "Buildings-${Environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: building_id
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
      KeySchema:
        - AttributeName: building_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UserIDIndex
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  LoginUsersTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "LoginUsers-${Environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: mobile
          AttributeType: S
      KeySchema:
        - AttributeName: mobile
          KeyType: HASH

  SuperAdminsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "SuperAdmins-${Environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: admin_id
          AttributeType: S
      KeySchema:
        - AttributeName: admin_id
          KeyType: HASH

  UserUnitsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "UserUnits-${Environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: unit_id
          AttributeType: S
      KeySchema:
        - AttributeName: unit_id
          KeyType: HASH

  UsersTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "Users-${Environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: mobile
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: mobile-index
          KeySchema:
            - AttributeName: mobile
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  MaintenanceTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "MaintenanceRecords-${Environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: maintenance_id
          AttributeType: S
        - AttributeName: building_id
          AttributeType: S
      KeySchema:
        - AttributeName: maintenance_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: BuildingIndex
          KeySchema:
            - AttributeName: building_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  PaymentTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "PaymentRecords-${Environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: payment_id
          AttributeType: S
        - AttributeName: maintenance_id
          AttributeType: S
        - AttributeName: unit_maintenance_id
          AttributeType: S
      KeySchema:
        - AttributeName: payment_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: MaintenanceIndex
          KeySchema:
            - AttributeName: maintenance_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: UnitMaintenanceIndex
          KeySchema:
            - AttributeName: unit_maintenance_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  UserBuildingsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "UserBuildingsTable-${Environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: building_id
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
      KeySchema:
        - AttributeName: building_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UserIDIndex
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  UnitMaintenanceTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "UnitMaintenanceBills-${Environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: unit_maintenance_id
          AttributeType: S
        - AttributeName: building_id
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
      KeySchema:
        - AttributeName: unit_maintenance_id
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: BuildingIndex
          KeySchema:
            - AttributeName: building_id
              KeyType: HASH
            - AttributeName: sk
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: UserIndex
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  MembersTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "MembersTable-${Environment}"
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: building_id
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
        - IndexName: building-index
          KeySchema:
            - AttributeName: building_id
              KeyType: HASH
            - AttributeName: user_id
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # ==================== API GATEWAY ====================
  ServerlessApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub "maintenance-serverless-api-${Environment}-${AWS::StackName}"
      StageName: !Ref Environment
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,PATCH,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization'"
        AllowOrigin: "'*'"
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${UserPoolId}"
            Identity:
              Header: Authorization
              ValidationExpression: ^Bearer [-0-9a-zA-Z\._]*$
              ReauthorizeEvery: 0

  # ==================== AUTH FUNCTIONS ====================
  LoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "login-${Environment}"
      Handler: auth.login.lambda_handler
      Environment:
        Variables:
          TABLE_USERS: !Ref UsersTable
          TABLE_LOGIN: !Ref LoginUsersTable
          ENVIRONMENT: !Ref Environment
          COGNITO_CLIENT_ID: !Ref CognitoClientId
          USER_POOL_ID: !Ref UserPoolId
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref LoginUsersTable
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:AdminInitiateAuth
                - cognito-idp:AdminRespondToAuthChallenge
                - cognito-idp:GetUser
                - cognito-idp:InitiateAuth
                - cognito-idp:RespondToAuthChallenge
                - cognito-idp:AdminUpdateUserAttributes
              Resource: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${UserPoolId}"
      Events:
        LoginAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /login
            Method: POST
            Auth:
              None: true

  RegisterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "register-${Environment}"
      Handler: auth.register.lambda_handler
      Environment:
        Variables:
          TABLE_USERS: !Ref UsersTable
          TABLE_LOGIN: !Ref LoginUsersTable
          ENVIRONMENT: !Ref Environment
          COGNITO_CLIENT_ID: !Ref CognitoClientId
          USER_POOL_ID: !Ref UserPoolId
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref LoginUsersTable
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:AdminGetUser
                - cognito-idp:AdminCreateUser
                - cognito-idp:AdminSetUserPassword
                - cognito-idp:AdminDeleteUser
              Resource: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${UserPoolId}"
      Events:
        RegisterAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /register
            Method: POST
            Auth:
              None: true

  # ==================== BUILDING FUNCTIONS ====================
  AddBuildingFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "add-building-${Environment}"
      Handler: building.add_building.lambda_handler
      Environment:
        Variables:
          TABLE_BUILDINGS: !Ref BuildingsTable
          USERS_TABLE: !Ref UsersTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref BuildingsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
      Events:
        AddBuildingAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /add_building
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  GetBuildingFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "get-building-${Environment}"
      Handler: building.get_building.lambda_handler
      Environment:
        Variables:
          TABLE_BUILDINGS: !Ref BuildingsTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref BuildingsTable
      Events:
        GetBuildingAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /get_building
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  UpdateBuildingFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "update-building-${Environment}"
      Handler: building.update_building.lambda_handler
      Environment:
        Variables:
          TABLE_BUILDINGS: !Ref BuildingsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref BuildingsTable
      Events:
        UpdateBuildingAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /update_building
            Method: PATCH
            Auth:
              Authorizer: CognitoAuthorizer

  DeleteBuildingFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "delete-building-${Environment}"
      Handler: building.delete_building.lambda_handler
      Environment:
        Variables:
          TABLE_BUILDINGS: !Ref BuildingsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref BuildingsTable
      Events:
        DeleteBuildingAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /delete_building
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthorizer

  # ==================== UNIT FUNCTIONS ====================
  AssignUnitFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "assign-unit-${Environment}"
      Handler: unit.assign_unit.lambda_handler
      Environment:
        Variables:
          TABLE_USERUNITS: !Ref UserUnitsTable
          USERS_TABLE: !Ref UsersTable
          TABLE_BUILDINGS: !Ref BuildingsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UserUnitsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref BuildingsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
      Events:
        AssignUnitAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /assign_unit
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  GetMyUnitsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "get-my-units-${Environment}"
      Handler: unit.get_my_units.lambda_handler
      Environment:
        Variables:
          TABLE_USERUNITS: !Ref UserUnitsTable
          TABLE_BUILDINGS: !Ref BuildingsTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UserUnitsTable
        - DynamoDBReadPolicy:
            TableName: !Ref BuildingsTable
      Events:
        GetMyUnitsAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /get_my_units
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  GetUserUnitsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "get-user-units-${Environment}"
      Handler: unit.user_units_get.lambda_handler
      Environment:
        Variables:
          USER_UNITS_TABLE: !Ref UserUnitsTable
          USERS_TABLE: !Ref UsersTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UserUnitsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
      Events:
        GetUserUnitsAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /user_units_get
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  # ==================== UNIT MAINTENANCE FUNCTIONS ====================
  UnitMaintenanceCreateFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "unit-maintenance-create-${Environment}"
      Handler: unit.create_unit_maintenance.lambda_handler
      Environment:
        Variables:
          TABLE_UNIT_MAINTENANCE: !Ref UnitMaintenanceTable
          USERS_TABLE: !Ref UsersTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UnitMaintenanceTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
      Events:
        UnitMaintenanceCreateAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /unit_maintenance
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  UnitMaintenanceGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "unit-maintenance-get-${Environment}"
      Handler: unit.get_unit_maintenance.lambda_handler
      Environment:
        Variables:
          TABLE_UNIT_MAINTENANCE: !Ref UnitMaintenanceTable
          USERS_TABLE: !Ref UsersTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UnitMaintenanceTable
      Events:
        UnitMaintenanceGetAllAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /unit_maintenance
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        UnitMaintenanceGetByIdAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /unit_maintenance/{unit_maintenance_id}
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  UnitMaintenanceDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "unit-maintenance-delete-${Environment}"
      Handler: unit.delete_unit_maintenance.lambda_handler
      Environment:
        Variables:
          TABLE_UNIT_MAINTENANCE: !Ref UnitMaintenanceTable
          USERS_TABLE: !Ref UsersTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UnitMaintenanceTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
      Events:
        UnitMaintenanceDeleteAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /unit_maintenance/{unit_maintenance_id}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthorizer

  # ==================== MAINTENANCE FUNCTIONS ====================
  MaintenanceManagementFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "maintenance-management-${Environment}"
      Handler: maintenance.maintenance_management.lambda_handler
      Environment:
        Variables:
          TABLE_MAINTENANCE: !Ref MaintenanceTable
          TABLE_PAYMENT: !Ref PaymentTable
          TABLE_BUILDINGS: !Ref BuildingsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MaintenanceTable
        - DynamoDBCrudPolicy:
            TableName: !Ref PaymentTable
        - DynamoDBCrudPolicy:
            TableName: !Ref BuildingsTable
      Events:
        MaintenanceGET:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /maintenance
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        MaintenancePOST:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /maintenance
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  GetMaintenanceByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "get-maintenance-by-id-${Environment}"
      Handler: maintenance.get_maintenance.lambda_handler
      Environment:
        Variables:
          TABLE_MAINTENANCE: !Ref MaintenanceTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref MaintenanceTable
      Events:
        GetMaintenanceByIdAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /maintenance/{maintenance_id}
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  GetBuildingMaintenanceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "get-building-maintenance-${Environment}"
      Handler: maintenance.get_building_maintenance.lambda_handler
      Environment:
        Variables:
          TABLE_MAINTENANCE: !Ref MaintenanceTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref MaintenanceTable
      Events:
        GetBuildingMaintenanceAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /maintenance/building/{building_id}
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  DeleteMaintenanceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "delete-maintenance-${Environment}"
      Handler: maintenance.delete_maintenance.lambda_handler
      Environment:
        Variables:
          TABLE_MAINTENANCE: !Ref MaintenanceTable
          TABLE_PAYMENT: !Ref PaymentTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MaintenanceTable
        - DynamoDBReadPolicy:
            TableName: !Ref PaymentTable
      Events:
        DeleteMaintenanceAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /maintenance/{maintenance_id}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthorizer

  # ==================== PAYMENT FUNCTIONS ====================
  PaymentFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "payment-processing-${Environment}"
      Handler: payment.payment_processing.lambda_handler
      Environment:
        Variables:
          TABLE_MAINTENANCE: !Ref MaintenanceTable
          TABLE_PAYMENT: !Ref PaymentTable
          TABLE_UNIT_MAINTENANCE: !Ref UnitMaintenanceTable
          TABLE_USERS: !Ref UsersTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MaintenanceTable
        - DynamoDBCrudPolicy:
            TableName: !Ref PaymentTable
        - DynamoDBCrudPolicy:
            TableName: !Ref UnitMaintenanceTable
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
      Events:
        PaymentProcessPOST:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /payment/process
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        PaymentGET:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /payment
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        PaymentReceipt:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /payment/receipt
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        PaymentVerify:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /payment/verify
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  # ==================== USER BUILDING FUNCTIONS ====================
  GetUserBuildingFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "get-user-building-${Environment}"
      Handler: building.get_user_building.lambda_handler
      Environment:
        Variables:
          TABLE_BUILDINGS: !Ref BuildingsTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref BuildingsTable
      Events:
        GetUserBuildingAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /get_user_building
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  GetUserBuildingsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "get-user-buildings-${Environment}"
      Handler: building.get_user_buildings.lambda_handler
      Environment:
        Variables:
          TABLE_BUILDINGS: !Ref BuildingsTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref BuildingsTable
      Events:
        GetUserBuildingsAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /get_user_buildings
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  # ==================== MEMBER FUNCTIONS ====================
  CreateMemberFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "create-member-${Environment}"
      Handler: members.create_member.lambda_handler
      Environment:
        Variables:
          MEMBERS_TABLE: !Ref MembersTable
          USERS_TABLE: !Ref UsersTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MembersTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
      Events:
        CreateMemberAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /members
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  GetMemberFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "get-member-${Environment}"
      Handler: members.get_member.lambda_handler
      Environment:
        Variables:
          MEMBERS_TABLE: !Ref MembersTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref MembersTable
      Events:
        GetAllMembersAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /members
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        GetMemberByIdAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /members/{user_id}
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  UpdateMemberFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "update-member-${Environment}"
      Handler: members.update_member.lambda_handler
      Environment:
        Variables:
          MEMBERS_TABLE: !Ref MembersTable
          USERS_TABLE: !Ref UsersTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MembersTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
      Events:
        UpdateMemberAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /members/{user_id}
            Method: PATCH
            Auth:
              Authorizer: CognitoAuthorizer

  DeleteMemberFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "delete-member-${Environment}"
      Handler: members.delete_member.lambda_handler
      Environment:
        Variables:
          MEMBERS_TABLE: !Ref MembersTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MembersTable
      Events:
        DeleteMemberAPI:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /members/{user_id}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthorizer

Outputs:
  ApiUrl:
    Description: "API Gateway Invoke URL"
    Value: !Sub "https://${ServerlessApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/"
  LoginLambda:
    Description: "Login Lambda Function"
    Value: !Ref LoginFunction
  AddBuildingLambda:
    Description: "Add Building Lambda Function"
    Value: !Ref AddBuildingFunction
  BuildingsTableName:
    Description: "Buildings DynamoDB Table Name"
    Value: !Ref BuildingsTable
  MaintenanceTableName:
    Description: "Maintenance Table Name"
    Value: !Ref MaintenanceTable
  PaymentTableName:
    Description: "Payment Table Name"
    Value: !Ref PaymentTable
  UserBuildingsTableName:
    Description: "UserBuildings DynamoDB Table Name"
    Value: !Ref UserBuildingsTable
  UnitMaintenanceTableName:
    Description: "Unit Maintenance Bills DynamoDB Table"
    Value: !Ref UnitMaintenanceTable
  GetUserBuildingsLambda:
    Description: "Get User Buildings Lambda Function"
    Value: !Ref GetUserBuildingsFunction
  MembersTableName:
    Description: "Members Table Name"
    Value: !Ref MembersTable
  CreateMemberLambda:
    Description: "Create Member Lambda Function"
    Value: !Ref CreateMemberFunction
  GetMemberLambda:
    Description: "Get Member Lambda Function"
    Value: !Ref GetMemberFunction